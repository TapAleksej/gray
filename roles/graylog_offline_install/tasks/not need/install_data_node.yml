---

- name: Copy Graylog DataNode RPM to target host
  become: true
  copy:
    src: "{{ graylog_datanode_rpm }}"
    dest: "/tmp/{{ graylog_datanode_rpm }}"

- name: Install Graylog DataNode RPM locally (offline, nogpgcheck)
  become: true
  command: "dnf install -y --nogpgcheck /tmp/{{ graylog_datanode_rpm }}"

- name: Ensure /etc/graylog/datanode directory exists
  become: true
  file:
    path: /etc/graylog/datanode
    state: directory
    owner: graylog
    group: graylog
    mode: '0750'

- name: Enable and start Graylog DataNode service
  become: true
  systemd:
    name: graylog-datanode
    enabled: true
    state: started

# --- Wait until DataNode API is up (8999) ---
- name: Wait until Graylog DataNode REST API is reachable
  uri:
    url: "http://127.0.0.1:8999/api/cluster/health"
    method: GET
    status_code: 200
    validate_certs: no
  register: datanode_health
  retries: 20
  delay: 3
  until: datanode_health.status == 200
  ignore_errors: yes
