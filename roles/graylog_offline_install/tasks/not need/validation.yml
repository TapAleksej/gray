---
# Проверка готовности MongoDB, OpenSearch и валидации Graylog перед запуском

- name: Wait for MongoDB to be available on port 27017
  become: true
  wait_for:
    host: 127.0.0.1
    port: 27017
    delay: 5
    timeout: 60
    state: started
  register: mongodb_status

- name: Check MongoDB availability using mongo shell
  become: true
  command: mongo --quiet --eval "db.runCommand({ connectionStatus: 1 })"
  register: mongo_check
  changed_when: false
  failed_when: "'ok' not in mongo_check.stdout and '1' not in mongo_check.stdout"
  when: mongodb_status is succeeded

- name: Wait for OpenSearch to be available on port 9200
  become: true
  wait_for:
    host: 127.0.0.1
    port: 9200
    delay: 5
    timeout: 60
    state: started
  register: opensearch_status

- name: Validate OpenSearch cluster health
  become: true
  uri:
    url: "http://127.0.0.1:9200/_cluster/health"
    method: GET
    return_content: true
  register: opensearch_health
  changed_when: false
  failed_when:
    - "'green' not in opensearch_health.content"
    - "'yellow' not in opensearch_health.content"
  when: opensearch_status is succeeded

# Проверка Graylog конфигурации
- name: Verify Graylog configuration syntax (if tool available)
  become: true
  command: /usr/share/graylog-server/bin/graylogctl check-config
  register: graylog_conf_check
  changed_when: false
  failed_when: graylog_conf_check.rc != 0
  ignore_errors: true
  args:
    warn: false

- name: Show Graylog configuration validation result
  debug:
    msg: >-
      Graylog configuration check:
      {{ '✅ OK' if graylog_conf_check.rc == 0 else '❌ FAILED (' ~ graylog_conf_check.rc ~ ')' }}
