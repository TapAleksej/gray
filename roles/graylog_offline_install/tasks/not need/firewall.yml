---
# =====================================================
# VARIABLES (EXPECTED FROM INVENTORY / DEFAULTS)
# =====================================================
# beats_port: 5044
# metricbeat_is_local: true | false

# =====================================================
# CHECK FIREWALLD
# =====================================================

- name: Check if firewalld is installed
  command: command -v firewall-cmd
  register: firewalld_present
  ignore_errors: true
  changed_when: false

# =====================================================
# ================= FIREWALLD PATH ====================
# =====================================================

- block:

    - name: Enable firewalld
      become: true
      systemd:
        name: firewalld
        enabled: true
        state: started

    # -----------------------------
    # BASE SERVICES
    # -----------------------------

    - name: Allow SSH
      become: true
      firewalld:
        service: ssh
        permanent: true
        state: enabled
        immediate: yes

    - name: Allow HTTP/HTTPS
      become: true
      firewalld:
        service: "{{ item }}"
        permanent: true
        state: enabled
        immediate: yes
      loop:
        - http
        - https

    # -----------------------------
    # BEATS (OPTIONAL)
    # -----------------------------

    - name: Allow Beats port (only if remote)
      become: true
      firewalld:
        port: "{{ beats_port }}/tcp"
        permanent: true
        state: enabled
        immediate: yes
      when: metricbeat_is_local == false

    # -----------------------------
    # REMOVE DANGEROUS PORTS
    # -----------------------------

    - name: Ensure ES/Mongo/Graylog ports are NOT exposed
      become: true
      firewalld:
        port: "{{ item }}/tcp"
        permanent: true
        state: disabled
        immediate: yes
      loop:
        - 9000
        - 9200
        - 27017

    - name: Reload firewalld
      become: true
      command: firewall-cmd --reload

  when: firewalld_present.rc == 0

# =====================================================
# ================= IPTABLES PATH =====================
# =====================================================

- block:

    # -----------------------------
    # FLUSH OLD RULES
    # -----------------------------

    - name: Flush iptables rules
      become: true
      iptables:
        flush: true

    # -----------------------------
    # BASE RULES
    # -----------------------------

    - name: Allow loopback
      become: true
      iptables:
        chain: INPUT
        in_interface: lo
        jump: ACCEPT

    - name: Allow established/related connections
      become: true
      iptables:
        chain: INPUT
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT

    # -----------------------------
    # PUBLIC PORTS
    # -----------------------------

    - name: Allow SSH
      become: true
      iptables:
        chain: INPUT
        protocol: tcp
        destination_port: 22
        jump: ACCEPT

    - name: Allow HTTP/HTTPS
      become: true
      iptables:
        chain: INPUT
        protocol: tcp
        destination_port: "{{ item }}"
        jump: ACCEPT
      loop:
        - 80
        - 443

    # -----------------------------
    # BEATS (OPTIONAL)
    # -----------------------------

    - name: Allow Beats port (only if remote)
      become: true
      iptables:
        chain: INPUT
        protocol: tcp
        destination_port: "{{ beats_port }}"
        jump: ACCEPT
      when: metricbeat_is_local == false

    # -----------------------------
    # DROP EVERYTHING ELSE
    # -----------------------------

    - name: Set default INPUT policy to DROP
      become: true
      iptables:
        chain: INPUT
        policy: DROP

    # -----------------------------
    # SAVE RULES
    # -----------------------------

    - name: Save iptables rules
      become: true
      command: service iptables save
      failed_when: false

  when: firewalld_present.rc != 0
