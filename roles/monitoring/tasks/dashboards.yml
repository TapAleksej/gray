---
- name: Wait for Graylog API
  uri:
    url: "{{ graylog_api_url }}/system"
    method: GET
    user: "{{ graylog_root_user }}"
    password: "{{ graylog_root_password }}"
    force_basic_auth: true
    headers:
      X-Requested-By: ansible
  register: api_check
  retries: 10
  delay: 6
  until: api_check.status == 200

- name: Create Metricbeat dashboard
  uri:
    url: "{{ graylog_api_url }}/dashboards"
    method: POST
    user: "{{ graylog_root_user }}"
    password: "{{ graylog_root_password }}"
    force_basic_auth: true
    headers:
      X-Requested-By: ansible
    body: "{{ lookup('template', 'dashboard_metricbeat.json.j2') }}"
    body_format: json
    status_code: [201, 409]
